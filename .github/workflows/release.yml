name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required to create releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Decode keystore from secret
        env:
          KEYSTORE_BASE64: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
        run: |
          echo "Decoding keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo "Keystore decoded successfully"

      - name: Build and sign JAR
        env:
          SIGNING_KEYSTORE: keystore.jks
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_ALIAS: ${{ secrets.SIGNING_ALIAS }}
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon
          echo "Build completed"

      - name: Verify JAR signature
        run: |
          JAR_FILE=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-dev.jar" | head -n 1)
          echo "Verifying signature on: $JAR_FILE"
          jarsigner -verify -verbose -certs "$JAR_FILE"
          if [ $? -eq 0 ]; then
            echo "âœ… JAR signature verified successfully"
          else
            echo "âŒ JAR signature verification failed"
            exit 1
          fi

      - name: Find JAR file
        id: find_jar
        run: |
          JAR_FILE=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-dev.jar" | head -n 1)
          echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_FILE"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_jar.outputs.jar_file }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup keystore
        if: always()
        run: |
          rm -f keystore.jks
          echo "Keystore cleaned up"

      - name: Release summary
        run: |
          echo "ðŸŽ‰ Release created successfully!"
          echo "Version: ${{ steps.get_version.outputs.VERSION }}"
          echo "JAR: ${{ steps.find_jar.outputs.jar_name }}"
          echo "Signed: âœ…"
          echo "Release URL: ${{ steps.create_release.outputs.url }}"
